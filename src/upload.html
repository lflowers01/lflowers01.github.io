<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Upload Carousel Images</title>
<link rel="stylesheet" href="https://unpkg.com/98.css" />
<style>
  body { font-family: sans-serif; margin: 0; padding: 20px; }
  .upload-container { max-width: 700px; margin: auto; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
  .form-group input, .form-group textarea { width: 100%; padding: 8px; box-sizing: border-box; }
  .form-group textarea { min-height: 80px; resize: vertical; }
  .upload-button { padding: 10px 20px; cursor: pointer; margin-right: 10px; }
  .message { padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
  .message.success { background-color: #90EE90; color: #155724; display: block; }
  .message.error { background-color: #FFB6C6; color: #721c24; display: block; }
  .images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
  .image-item { background: #f0f0f0; padding: 10px; border-radius: 4px; cursor: move; border: 2px solid transparent; transition: all 0.2s; }
  .image-item.dragging { opacity: 0.5; border: 2px dashed #999; }
  .image-item.drag-over { border: 2px solid #0066cc; background: #e6f2ff; }
  .image-item img { width: 100%; height: 150px; object-fit: cover; margin-bottom: 10px; border-radius: 3px; }
  .image-info { font-size: 12px; margin-bottom: 8px; }
  .image-description { font-weight: bold; margin-bottom: 4px; word-break: break-word; }
  .image-controls { display: flex; gap: 5px; }
  .delete-btn, .edit-btn { flex: 1; padding: 5px; cursor: pointer; border: none; font-size: 11px; border-radius: 2px; }
  .delete-btn { background-color: #ff6b6b; color: white; }
  .edit-btn { background-color: #4CAF50; color: white; }
  .reorder-hint { font-size: 12px; color: #666; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 3px; }
</style>
</head>
<body>
<div class="upload-container">
  <h2>Upload & Manage Carousel Images</h2>
  <div style="background: #e6f2ff; padding: 15px; border-radius: 4px; margin-bottom: 20px; color: #003366;">
    <strong>‚ÑπÔ∏è Development Mode Only</strong>
    <p>This upload page only works locally during development.</p>
  </div>

  <form id="uploadForm">
    <div class="form-group">
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required />
    </div>
    <div class="form-group">
      <label for="image">Select Image:</label>
      <input type="file" id="image" name="image" accept="image/*" required />
    </div>
    <div class="form-group">
      <label for="description">Description (optional):</label>
      <textarea id="description" name="description" placeholder="Add a description..."></textarea>
    </div>
    <button type="submit" class="upload-button">Upload Image</button>
  </form>

  <div id="message" class="message"></div>

  <h3>Carousel Images (<span id="imageCount">0</span>)</h3>
  <div class="reorder-hint">üí° Drag and drop images to reorder them</div>
  <div id="imagesList" class="images-grid"></div>
</div>

<script>
const uploadForm = document.getElementById('uploadForm');
const message = document.getElementById('message');
const imagesList = document.getElementById('imagesList');
const imageCount = document.getElementById('imageCount');

const API_URL = 'http://localhost:3001/api';

function showMessage(text, type='success') {
  message.textContent = text;
  message.className = 'message ' + type;
  setTimeout(() => { message.style.display = 'none'; }, 4000);
}

// Fetch carousel images
async function loadImages() {
  try {
    const res = await fetch(`${API_URL}/carousel`);
    const images = await res.json();
    imagesList.innerHTML = '';
    imageCount.textContent = images.length;
    images.forEach(img => addImageItem(img));
  } catch(e) {
    showMessage('Failed to load images', 'error');
  }
}

function addImageItem(img) {
  const div = document.createElement('div');
  div.className = 'image-item';
  div.draggable = true;
  div.dataset.id = img.id;
  div.innerHTML = `
    <img src="/carousel/${img.filename}" alt="${img.description}" />
    <div class="image-info">
      <div class="image-description">${img.description}</div>
    </div>
    <div class="image-controls">
      <button class="delete-btn">Delete</button>
    </div>
  `;
  const deleteBtn = div.querySelector('.delete-btn');
  deleteBtn.addEventListener('click', async () => {
    if(!confirm('Delete this image?')) return;
    const res = await fetch(`${API_URL}/delete/${img.id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: document.getElementById('password').value })
    });
    const data = await res.json();
    if(data.success) { showMessage('Deleted image'); loadImages(); }
    else showMessage(data.error, 'error');
  });
  enableDragAndDrop(div);
  imagesList.appendChild(div);
}

// Handle upload
uploadForm.addEventListener('submit', async e => {
  e.preventDefault();
  const file = document.getElementById('image').files[0];
  const password = document.getElementById('password').value;
  const description = document.getElementById('description').value;
  if(!file) return showMessage('Select an image', 'error');

  const formData = new FormData();
  formData.append('image', file);
  formData.append('password', password);
  formData.append('description', description);

  try {
    const res = await fetch(`${API_URL}/upload`, { method: 'POST', body: formData });
    const data = await res.json();
    if(data.success) {
      showMessage('Upload successful');
      uploadForm.reset();
      loadImages();
    } else {
      showMessage(data.error, 'error');
    }
  } catch(e) { showMessage('Upload failed', 'error'); }
});

// Drag & drop reorder
function enableDragAndDrop(item) {
  let dragSrcEl = null;
  item.addEventListener('dragstart', e => { dragSrcEl = item; item.classList.add('dragging'); });
  item.addEventListener('dragend', e => { item.classList.remove('dragging'); });
  item.addEventListener('dragover', e => { e.preventDefault(); item.classList.add('drag-over'); });
  item.addEventListener('dragleave', e => { item.classList.remove('drag-over'); });
  item.addEventListener('drop', async e => {
    e.preventDefault(); item.classList.remove('drag-over');
    if(dragSrcEl === item) return;
    const children = Array.from(imagesList.children);
    const fromIndex = children.indexOf(dragSrcEl);
    const toIndex = children.indexOf(item);
    imagesList.insertBefore(dragSrcEl, toIndex > fromIndex ? item.nextSibling : item);
    const newOrder = Array.from(imagesList.children).map(c => c.dataset.id);
    try {
      await fetch(`${API_URL}/reorder`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: document.getElementById('password').value, newOrder })
      });
      showMessage('Reordered images');
    } catch(e) { showMessage('Reorder failed', 'error'); }
  });
}

loadImages();
</script>
</body>
</html>
